<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Syntactic Creator - Didactic Edition</title>
    <style>
        :root { 
            --main-font: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            --bg-color: #f4f4f9;
            --container-bg: #ffffff;
            --primary-color: #007bff;
            --text-color: #333;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* GLOBAL FONT RESET */
        body, button, input, textarea, select { 
            font-family: var(--main-font); 
        }

        body { 
            margin: 2% auto; 
            max-width: 1200px;
            padding: 0 20px;
            background-color: var(--bg-color); 
            color: var(--text-color); 
        }

        h1 { text-align: center; color: #444; margin-bottom: 20px; font-weight: normal; letter-spacing: 1px; font-size: 1.8rem; }

        .container { 
            background: var(--container-bg); 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: var(--shadow); 
            margin-bottom: 20px; 
            position: relative;
        }
        
        /* Language Toggle */
        .lang-switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }
        .lang-btn {
            background: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            opacity: 0.6;
        }
        .lang-btn.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
            opacity: 1;
            font-weight: bold;
        }

        .instruction-box { 
            background: #fff3cd; 
            border: 1px solid #ffeeba; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            font-size: 0.9rem; 
            line-height: 1.5; 
            color: #856404;
        }
        .instruction-box h3 { margin-top: 0; border-bottom: 1px solid #ffeeba; padding-bottom: 5px; font-size: 1rem; }
        .instruction-box a { color: #856404; text-decoration: underline; font-weight: bold; cursor: pointer; }

        /* PALETTE */
        .palette { 
            position: sticky; top: 0; 
            background: white; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            z-index: 1000; 
            box-shadow: var(--shadow); 
            margin-bottom: 15px; 
        }
        .palette-grid { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
        .p-btn { 
            padding: 5px 10px; 
            border-radius: 5px; 
            border: 2px solid transparent; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.8rem; 
            transition: all 0.2s; 
            color: black !important; 
        }
        .p-btn.active { border-color: #333; transform: scale(1.05); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* COMPACT EDITOR AREA */
        #tagging-area { 
            padding: 30px; 
            border: 1px solid #e0e0e0; 
            min-height: 400px; 
            background: #fff; 
            border-radius: 8px; 
            display: block; 
            line-height: 4.5; 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }
        
        /* COMPACT WORDS */
        .tag-word { 
            display: inline-block; 
            margin: 0 2px; 
            position: relative; 
            font-size: 1.15rem; 
            vertical-align: middle; 
            color: black; 
            padding: 2px 8px; 
            border-radius: 4px; 
            cursor: pointer; 
            border-bottom: 2px solid #ccc; 
            white-space: nowrap; 
            height: 1.6rem; 
            line-height: 1.6rem; 
        }
        
        /* Punctuation */
        .punct-span { display: inline-block; margin: 0 1px; font-size: 1.15rem; vertical-align: middle; color: black; background: transparent; border: none; padding: 0; font-weight: bold; cursor: default; }

        /* Visual Styles for Groups in Editor */
        .grouped-word { border-bottom: 4px solid #6f42c1 !important; background-color: #f3e5f5; }
        .group-start { border-left: 2px solid #6f42c1; border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .group-end { border-right: 2px solid #6f42c1; border-top-right-radius: 0; border-bottom-right-radius: 0; }

        .split-right { border-right: 4px dashed #ff4444 !important; margin-right: 12px; }
        
        /* COMPACT LABEL (SHORT FORM) */
        .tag-word::after { 
            content: attr(data-short); 
            display: block; 
            position: absolute; 
            top: 36px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 0.6rem; 
            color: #d32f2f; 
            font-weight: 800; 
            text-transform: uppercase; 
            pointer-events: none;
            background: rgba(255,255,255,0.9);
            padding: 0 3px;
            line-height: 1.1;
            border-radius: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .side-panel { background: #eee; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .group-item { background: white; padding: 8px; margin: 5px 0; border-radius: 6px; display: flex; justify-content: space-between; border-left: 5px solid #6f42c1; align-items: center; font-size: 0.9rem; }
        
        /* Buttons */
        .btn-action { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; font-size: 0.9rem; }
        .btn-action:hover { opacity: 0.9; }
        
        /* Active State for Tool Buttons */
        .btn-action.active-mode {
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.3);
            transform: scale(0.98);
            outline: 3px solid #333;
        }
        #split-mode-btn.active-mode { outline-color: #dc3545; background: #c82333 !important; }
        #group-mode-btn.active-mode { outline-color: #6f42c1; background: #5a32a3 !important; }

        .del-btn { color: #ff4444; cursor: pointer; font-weight: bold; padding: 0 10px; font-size: 1.2rem; }

        .custom-label-row { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; display: flex; gap: 5px; align-items: center; }
        .custom-input { flex-grow: 1; padding: 5px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; }
        .add-btn { background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }

        /* Subtle Save/Load Row */
        .project-mini-row { 
            margin-top: 15px; 
            padding-top: 10px; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: flex-end; 
            gap: 15px; 
        }
        .subtle-btn {
            background: transparent;
            color: #666;
            border: 1px solid #ccc;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .subtle-btn:hover { background: #f0f0f0; color: #333; border-color: #999; }

        /* Input Row in Setup */
        .setup-row { display: flex; gap: 15px; margin-bottom: 20px; }
        .setup-input { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; }

        /* Credits Link */
        .credits-link {
            text-align: center;
            margin-top: 30px;
            font-size: 0.85rem;
        }
        .credits-link a { color: #666; text-decoration: none; border-bottom: 1px dashed #999; cursor: pointer; }
        .credits-link a:hover { color: #000; border-bottom-style: solid; }

        /* MODAL STYLES */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-title { font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 20px; font-size: 1.1rem; box-sizing: border-box; border: 2px solid #007bff; border-radius: 5px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }

        /* MOBILE / TABLET OPTIMIZATIONS */
        @media (max-width: 768px) {
            body { margin: 10px; padding: 0; }
            .container { padding: 15px; }
            .setup-row { flex-direction: column; gap: 10px; }
            .lang-switch { top: 10px; right: 10px; }
            
            .palette { position: relative; top: 0; padding: 10px; overflow-x: auto; }
            .palette-grid { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; }
            .p-btn { white-space: nowrap; padding: 12px 15px; } 

            #tagging-area { padding: 15px; line-height: 4.5; } 
            .tag-word { font-size: 1rem; padding: 4px 6px; margin: 1px; }
            .tag-word::after { font-size: 0.5rem; top: 32px; }
            
            .btn-action { width: 100%; margin-bottom: 8px; font-size: 1rem; }
            .modal-box { width: 90%; }
        }
        
        /* AUTO SAVE NOTIFICATION */
        #autosave-status {
            position: fixed; bottom: 10px; right: 10px; font-size: 0.8rem; color: #888; opacity: 0; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <h1 id="app-heading">Syntactic Analysis Creator</h1>

    <div id="setup-screen" class="container">
        
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLanguage('en')">ðŸ‡¬ðŸ‡§ English</button>
            <button class="lang-btn" onclick="setLanguage('de')">ðŸ‡©ðŸ‡ª Deutsch</button>
        </div>

        <div class="instruction-box">        
            <h3 id="instr-h3">Step 1: Setup Instruction</h3>
            <div id="instr-body">
                This page allows you to create your own sentences for syntactical analysis. The idea is that you give your students some support with the analysis and translation, e.g. by indicating which groups of words belong together, and that your students understand the syntax of a sentence before they start translating.<br>
                On this page, you will be asked to provide a title, optional notes for the students, a picture for the student page (optional) and a text or a few sentences. Then, click 'Copy AI Prompt' and paste the prompt into a large language model such as ChatGPT or Gemini. Finally, paste the JSON code the AI gives you into the box and click 'Import' or 'Start manual creation'.
            </div>
            <div style="margin-top:15px; font-style:italic;">
                <span id="example-link-text">Want to see what the final result looks like?</span> <a href="example_page.html" target="_blank" id="link-example">View Example</a>
            </div>
        </div>
        
        <div class="setup-row">
            <input type="text" id="pagetitle" class="setup-input" placeholder="Exercise Title" style="flex: 2;"/>
            <input type="text" id="pageimage" class="setup-input" placeholder="Optional: Image URL" style="flex: 1;"/>
        </div>

        <textarea id="teachernotes" rows="3" style="width:100%; padding:10px; margin-bottom:20px; border-radius:6px; border:1px solid #ccc; font-size:1rem; box-sizing:border-box;" placeholder="Optional: Context / Teacher Notes (e.g. 'Watch out for ablatives...')"></textarea>

        <textarea id="entertext" rows="6" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1rem; box-sizing: border-box;" placeholder="Paste Latin text here..."></textarea>
        
        <div style="background:#eef6ff; padding:20px; border-radius:10px; margin:25px 0; border:2px dashed #007bff;">
            <button class="btn-action" style="background:#007bff;" onclick="copyAIPrompt()" id="btn-copy-ai">1. Copy AI Prompt</button>
            <textarea id="ai-json" rows="2" style="width:100%; margin: 15px 0; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box;" placeholder="Paste JSON here..."></textarea>
            <button class="btn-action" style="background:#28a745;" onclick="importAI()" id="btn-import">2. Import</button>
            <span style="margin: 0 15px; font-weight:bold; color:#555;" id="or-text">OR</span>
            <label class="btn-action" style="background:#17a2b8; cursor: pointer; display:inline-block;">
                <span id="btn-load">Load Saved Project</span> <input type="file" style="display:none" onchange="loadProject(this)">
            </label>
        </div>
        <button class="btn-action" style="background:#3c3c3c; width:100%;" onclick="startManual()" id="btn-manual">Start Manual Creation</button>

        <div class="credits-link">
            <a onclick="showCredits()">Credits</a>
        </div>
    </div>

    <div id="credits-screen" class="container" style="display:none; text-align:center; padding: 50px;">
        <h2 style="margin-top:0;">Credentials</h2>
        <p style="font-size:1.1rem; line-height: 1.6; color: #555; margin: 30px 0;">
            This tool was created by Anke Walter. I gratefully acknowledge the help of J. L., ChatGPT and Gemini.
        </p>
        <button class="btn-action" style="background:#6c757d;" onclick="hideCredits()">Back</button>
    </div>

    <div id="editor-screen" style="display:none;">
        
        <div class="instruction-box">
            <h3 id="edit-h3">Step 2: Editing Instruction</h3>
            <ul style="margin-bottom:0; padding-left:20px;" id="edit-body">
                Revise the syntactic analysis. Adjacent words with same labels merge automatically, unless you use 'Manual Split' and click the first word to keep them separate. To create larger syntactic groups, click 'Draw Bracket', click the start and end word, then type to select a label. At the bottom of the page, you can review and remove syntactic groups. Use 'Undo' to revert your last action. At the end, hit 'Export Student Page'.
            </ul>
        </div>

        <div class="palette">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                 <div id="mode-status" style="font-weight:bold; color:#007bff; font-size:1rem;">Mode: Tagging (Other)</div>
                 <div class="custom-label-row" style="margin:0; padding:0; border:none;">
                    <input type="text" id="new-label-input" class="custom-input" placeholder="New Label" style="width:120px;">
                    <button class="add-btn" onclick="addCustomLabel()">+</button>
                </div>
            </div>

            <div class="palette-grid" id="label-palette"></div>
            
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;">
                <button class="btn-action" id="undo-btn" style="background:#ff9800; flex:0.5;" onclick="undo()">â†¶ Undo</button>
                <button class="btn-action" id="split-mode-btn" style="background:#dc3545; flex:1;" onclick="toggleSplitMode()">Manual Split</button>
                <button class="btn-action" id="group-mode-btn" style="background:#6f42c1; flex:1;" onclick="toggleGroupMode()">Draw Bracket</button>
                <button class="btn-action" style="background:#000; flex:1;" onclick="exportToStudent()" id="btn-export">Export Student Page</button>
            </div>

            <div class="project-mini-row">
                <button class="subtle-btn" onclick="saveProject()" id="btn-save-work">ðŸ’¾ Save Work</button>
                <label class="subtle-btn">
                    <span id="btn-load-work">ðŸ“‚ Load Work</span> <input type="file" style="display:none" onchange="loadProject(this)">
                </label>
            </div>
        </div>
        
        <div id="tagging-area"></div>

        <div class="side-panel">
            <strong id="active-group-title">Active Brackets (Syntactical Groups):</strong>
            <div id="group-list"></div>
        </div>
    </div>

    <div id="group-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" id="modal-title-text">Name this Syntactic Group:</div>
            <input type="text" id="group-name-input" class="modal-input" list="label-suggestions" placeholder="Type to search (e.g. 's' for Subject)...">
            <datalist id="label-suggestions"></datalist>
            
            <div class="modal-actions">
                <button class="btn-action" style="background:#6c757d; padding: 8px 15px;" onclick="closeGroupModal()" id="btn-cancel">Cancel</button>
                <button class="btn-action" style="background:#007bff; padding: 8px 15px;" onclick="saveGroupFromModal()" id="btn-save-group">Save Group</button>
            </div>
        </div>
    </div>
    
    <div id="autosave-status">Autosaved</div>

<script>
// --- MULTI-LANGUAGE CONFIG ---
let currentLang = 'en';

const LANG = {
    en: {
        heading: "Syntactic Analysis Creator",
        instrH3: "Step 1: Setup Instruction",
        instrBody: "This page allows you to create your own sentences for syntactical analysis. The idea is that you give your students some support with the analysis and translation, e.g. by indicating which groups of words belong together, and that your students understand the syntax of a sentence before they start translating.<br>On this page, you will be asked to provide a title, optional notes for the students, a picture for the student page (optional) and a text or a few sentences. Then, click 'Copy AI Prompt' and paste the prompt into a large language model such as ChatGPT or Gemini. Finally, paste the JSON code the AI gives you into the box and click 'Import' or 'Start manual creation'.",
        exampleLink: "Want to see what the final result looks like?",
        linkText: "View Example",
        phTitle: "Exercise Title",
        phImage: "Optional: Image URL",
        phNotes: "Optional: Context / Teacher Notes (e.g. 'Watch out for ablatives...')",
        phText: "Paste Latin text here...",
        phJson: "Paste JSON here...",
        btnCopy: "1. Copy AI Prompt",
        btnImport: "2. Import",
        btnLoad: "Load Saved Project",
        or: "OR",
        btnManual: "Start Manual Creation",
        editH3: "Step 2: Editing Instruction",
        editBody: "Revise the syntactic analysis. Adjacent words with same labels merge automatically, unless you use 'Manual Split' and click the first word to keep them separate. To create larger syntactic groups, click 'Draw Bracket', click the start and end word, then type to select a label. At the bottom of the page, you can review and remove syntactic groups. Use 'Undo' to revert your last action. At the end, hit 'Export Student Page'.",
        phLabel: "New Label",
        btnUndo: "â†¶ Undo",
        btnSplit: "Manual Split",
        btnBracket: "Draw Bracket",
        btnExport: "Export Student Page",
        btnSaveWork: "ðŸ’¾ Save Work",
        btnLoadWork: "ðŸ“‚ Load Work",
        groupTitle: "Active Brackets (Syntactical Groups):",
        modalTitle: "Name this Syntactic Group:",
        btnCancel: "Cancel",
        btnSaveGroup: "Save Group",
        modeTag: "Mode: Tagging",
        modeSplit: "Mode: Manual Split",
        modeBracket: "Mode: Drawing Bracket"
    },
    de: {
        heading: "Syntaktische Analyse - Ersteller",
        instrH3: "Schritt 1: Einrichtung",
        instrBody: "Diese Seite ermÃ¶glicht es Ihnen, eigene SÃ¤tze fÃ¼r die syntaktische Analyse zu erstellen. Die Idee ist, dass Sie Ihren SchÃ¼lern UnterstÃ¼tzung bei der Analyse und Ãœbersetzung geben, z. B. indem Sie anzeigen, welche Wortgruppen zusammengehÃ¶ren. So verstehen die SchÃ¼ler die Syntax eines Satzes, bevor sie mit der Ãœbersetzung beginnen.<br>Geben Sie einen Titel, optionale Hinweise, ein Bild (optional) und den lateinischen Text ein. Klicken Sie dann auf 'KI-Prompt kopieren', fÃ¼gen Sie diesen in ChatGPT oder Gemini ein und kopieren Sie den JSON-Code der KI in das Importfeld. Klicken Sie abschlieÃŸend auf 'Importieren' oder 'Manuell starten'.",
        exampleLink: "MÃ¶chten Sie sehen, wie das Ergebnis aussieht?",
        linkText: "Beispiel ansehen",
        phTitle: "Ãœbungstitel",
        phImage: "Optional: Bild-URL",
        phNotes: "Optional: Kontext / Lehrerhinweise (z.B. 'Achtet auf den Ablativ...')",
        phText: "Lateinischen Text hier einfÃ¼gen...",
        phJson: "JSON hier einfÃ¼gen...",
        btnCopy: "1. KI-Prompt kopieren",
        btnImport: "2. Importieren",
        btnLoad: "Gespeichertes Projekt laden",
        or: "ODER",
        btnManual: "Manuelle Erstellung starten",
        editH3: "Schritt 2: Bearbeitung",
        editBody: "ÃœberprÃ¼fen Sie die Analyse. Benachbarte WÃ¶rter mit gleicher Funktion verschmelzen automatisch, es sei denn, Sie nutzen 'Manuell trennen'. Um grÃ¶ÃŸere Gruppen zu erstellen, klicken Sie auf 'Klammer zeichnen', wÃ¤hlen Sie Start- und Endwort und benennen die Gruppe. Nutzen Sie 'RÃ¼ckgÃ¤ngig' bei Fehlern. Klicken Sie am Ende auf 'SchÃ¼lerseite exportieren'.",
        phLabel: "Neues Label",
        btnUndo: "â†¶ RÃ¼ckgÃ¤ngig",
        btnSplit: "Manuell trennen",
        btnBracket: "Klammer zeichnen",
        btnExport: "SchÃ¼lerseite exportieren",
        btnSaveWork: "ðŸ’¾ Speichern",
        btnLoadWork: "ðŸ“‚ Laden",
        groupTitle: "Aktive Klammern (Syntaktische Gruppen):",
        modalTitle: "Name der syntaktischen Gruppe:",
        btnCancel: "Abbrechen",
        btnSaveGroup: "Speichern",
        modeTag: "Modus: Markieren",
        modeSplit: "Modus: Manuell trennen",
        modeBracket: "Modus: Klammer zeichnen"
    }
};

// GRAMMAR CONFIG
const GRAMMAR = {
    en: {
        funcs: ['Subject', 'Accusative object', 'Dative object', 'Genitive object', 'Ablative', 'Predicative', 'Prepositional phrase', 'Adverb', 'Verb', 'Infinitive', 'Participial phrase', 'Relative clause', 'Subordinate clause', 'Other'],
        abbr: {
            'Subject': 'Subj', 'Accusative object': 'Acc. Obj', 'Dative object': 'Dat. Obj', 'Genitive object': 'Gen. Obj', 'Ablative': 'Abl', 'Predicative': 'Pred', 'Prepositional phrase': 'Prep. Phr', 'Adverb': 'Adv', 'Verb': 'Verb', 'Infinitive': 'Inf', 'Participial phrase': 'Part. Phr', 'Relative clause': 'Rel. Cl', 'Subordinate clause': 'Sub. Cl', 'Other': 'Other', 'Main clause': 'Main'
        }
    },
    de: {
        funcs: ['Subjekt', 'Akkusativobjekt', 'Dativobjekt', 'Genitivobjekt', 'Ablativ', 'PrÃ¤dikativum', 'PrÃ¤positionalphrase', 'Adverb', 'Verb', 'Infinitiv', 'Partizipialkonstruktion', 'Relativsatz', 'Nebensatz', 'Sonstiges'],
        abbr: {
            'Subjekt': 'Subj', 'Akkusativobjekt': 'Akk. Obj', 'Dativobjekt': 'Dat. Obj', 'Genitivobjekt': 'Gen. Obj', 'Ablativ': 'Abl', 'PrÃ¤dikativum': 'PrÃ¤d', 'PrÃ¤positionalphrase': 'PrÃ¤p. Phr', 'Adverb': 'Adv', 'Verb': 'Verb', 'Infinitiv': 'Inf', 'Partizipialkonstruktion': 'Part. Konstr', 'Relativsatz': 'Rel. Satz', 'Nebensatz': 'Nebensatz', 'Sonstiges': 'Sonst.', 'Main clause': 'Hauptsatz'
        }
    }
};

const BASE_COLORS = ['#66bb6a', '#42a5f5', '#ab47bc', '#26c6da', '#ffa726', '#e1bee7', '#fdd835', '#ffee58', '#ff4d4d', '#d32f2f', '#ffcdd2', '#78909c', '#8d6e63', '#e0e0e0'];

// Globals
let functions = [...GRAMMAR.en.funcs];
let abbreviations = {...GRAMMAR.en.abbr};
let colors = {}; 

function mapColors(funcList) {
    let c = {};
    funcList.forEach((f, i) => {
        c[f] = BASE_COLORS[i] || '#ccc';
    });
    return c;
}
colors = mapColors(functions);

// --- NAVIGATION FUNCTIONS ---
function showCredits() {
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('credits-screen').style.display = 'block';
}

function hideCredits() {
    document.getElementById('credits-screen').style.display = 'none';
    document.getElementById('setup-screen').style.display = 'block';
}

function setLanguage(lang) {
    const oldLang = currentLang;
    currentLang = lang;
    const txt = LANG[lang];
    
    // Update Toggle Buttons
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');

    // Update UI Text
    document.getElementById('app-heading').textContent = txt.heading;
    document.getElementById('instr-h3').textContent = txt.instrH3;
    document.getElementById('instr-body').innerHTML = txt.instrBody;
    document.getElementById('example-link-text').textContent = txt.exampleLink;
    document.getElementById('link-example').textContent = txt.linkText;
    document.getElementById('pagetitle').placeholder = txt.phTitle;
    document.getElementById('pageimage').placeholder = txt.phImage;
    document.getElementById('teachernotes').placeholder = txt.phNotes;
    document.getElementById('entertext').placeholder = txt.phText;
    document.getElementById('ai-json').placeholder = txt.phJson;
    document.getElementById('btn-copy-ai').textContent = txt.btnCopy;
    document.getElementById('btn-import').textContent = txt.btnImport;
    document.getElementById('or-text').textContent = txt.or;
    document.getElementById('btn-load').textContent = txt.btnLoad;
    document.getElementById('btn-manual').textContent = txt.btnManual;
    
    document.getElementById('edit-h3').textContent = txt.editH3;
    document.getElementById('edit-body').innerHTML = txt.editBody;
    document.getElementById('new-label-input').placeholder = txt.phLabel;
    
    document.getElementById('undo-btn').textContent = txt.btnUndo;
    document.getElementById('split-mode-btn').textContent = txt.btnSplit;
    document.getElementById('group-mode-btn').textContent = txt.btnBracket;
    document.getElementById('btn-export').textContent = txt.btnExport;
    document.getElementById('btn-save-work').textContent = txt.btnSaveWork;
    document.getElementById('btn-load-work').textContent = txt.btnLoadWork;
    document.getElementById('active-group-title').textContent = txt.groupTitle;
    document.getElementById('modal-title-text').textContent = txt.modalTitle;
    document.getElementById('btn-cancel').textContent = txt.btnCancel;
    document.getElementById('btn-save-group').textContent = txt.btnSaveGroup;

    // UPDATE EXAMPLE LINK
    const exampleLink = document.getElementById('link-example');
    if(lang === 'de') exampleLink.href = "example_page_de.html";
    else exampleLink.href = "example_page.html";

    // --- SMART TRANSLATION LOGIC ---
    if(document.getElementById('editor-screen').style.display === 'block') {
        const oldList = GRAMMAR[oldLang].funcs;
        const newList = GRAMMAR[lang].funcs;
        
        const idxActive = oldList.indexOf(activeFunc);
        if(idxActive !== -1) {
            activeFunc = newList[idxActive];
        }

        const wordSpans = document.querySelectorAll('.tag-word');
        wordSpans.forEach(span => {
            const currentF = span.dataset.func;
            const idx = oldList.indexOf(currentF);
            if(idx !== -1) {
                const newF = newList[idx];
                span.dataset.func = newF;
                
                const newAbbr = GRAMMAR[lang].abbr[newF] || (newF.length > 6 ? newF.substring(0,5)+"." : newF);
                span.dataset.short = newAbbr;
                
                span.style.backgroundColor = BASE_COLORS[idx] || '#ccc';
            }
        });

        currentGroups.forEach(g => {
            const idx = oldList.indexOf(g.label);
            if(idx !== -1) {
                g.label = newList[idx];
            }
        });
        updateGroupUI();
    }

    functions = [...GRAMMAR[lang].funcs];
    abbreviations = {...GRAMMAR[lang].abbr};
    colors = mapColors(functions);
    
    if(document.getElementById('editor-screen').style.display === 'block') {
        renderPalette();
        updateStatus();
    }
}

const preps = ["a", "ab", "ad", "ante", "apud", "circum", "contra", "cum", "de", "e", "ex", "extra", "in", "infra", "inter", "intra", "ob", "per", "post", "prae", "pro", "prope", "propter", "sine", "sub", "super", "trans", "ultra"];
const sentenceEnders = ['.', '!', '?', 'Â·'];

let activeFunc = 'Other', groupMode = false, splitMode = false, startIdx = null, currentGroups = [];
let pendingGroupStart = null, pendingGroupEnd = null;
let historyStack = [];

// --- UNDO FUNCTIONALITY ---
function saveState() {
    const currentWords = Array.from(document.getElementById('tagging-area').childNodes).map(node => {
        const isPunct = node.classList.contains('punct-span');
        return { 
            w: node.textContent, 
            f: isPunct ? 'Punct' : (node.dataset.func || 'Other'),
            isSplit: node.classList.contains('split-right'),
            idx: node.dataset.idx
        };
    });
    const groupsCopy = JSON.parse(JSON.stringify(currentGroups));
    historyStack.push({ words: currentWords, groups: groupsCopy });
    if (historyStack.length > 50) historyStack.shift();
}

function undo() {
    if (historyStack.length === 0) {
        alert("Nothing to undo!");
        return;
    }
    const lastState = historyStack.pop();
    currentGroups = lastState.groups;
    restoreEditorState(lastState.words);
    startIdx = null; 
    document.querySelectorAll('.tag-word').forEach(s => s.style.outline = "none");
}

function restoreEditorState(words) {
    const area = document.getElementById('tagging-area');
    area.innerHTML = '';
    words.forEach((item, i) => {
        const span = document.createElement('span');
        const isPunct = item.f === 'Punct';
        span.textContent = item.w;
        span.className = isPunct ? 'punct-span' : 'tag-word';
        if (item.isSplit) span.classList.add('split-right');
        
        span.dataset.idx = i;
        span.id = `word-${i}`; 

        if(!isPunct) {
            let func = item.f || 'Other';
            if(func === "Main clause") func = "Other";
            
            if(!colors[func]) {
                 functions.push(func);
                 colors[func] = `hsl(${Math.floor(Math.random() * 360)}, 70%, 85%)`;
                 renderPalette();
            }
            span.dataset.func = func;
            
            const shortLabel = abbreviations[func] || (func.length > 6 ? func.substring(0,5)+"." : func);
            span.dataset.short = shortLabel;

            span.style.backgroundColor = colors[func];
            span.onclick = function() { handleWordClick(this); };
        } else { span.dataset.func = 'Punct'; }
        area.appendChild(span);
    });
    updateGroupUI();
}

// --- AUTO SAVE LOGIC ---
function triggerAutoSave() {
    if(document.getElementById('editor-screen').style.display === 'block' || document.getElementById('entertext').value.length > 5) {
        let currentWords = [];
        const taggingArea = document.getElementById('tagging-area');
        if(taggingArea.children.length > 0) {
             currentWords = Array.from(taggingArea.childNodes).map((node) => {
                const isPunct = node.classList.contains('punct-span');
                return { 
                    w: node.textContent, 
                    f: isPunct ? 'Punct' : (node.dataset.func || 'Other'),
                    isSplit: node.classList.contains('split-right')
                };
            });
        }
        
        const saveData = {
            lang: currentLang, 
            title: document.getElementById('pagetitle').value,
            image: document.getElementById('pageimage').value,
            text: document.getElementById('entertext').value,
            notes: document.getElementById('teachernotes').value,
            groups: currentGroups,
            funcs: functions,
            cols: colors,
            abbr: abbreviations,
            words: currentWords,
            timestamp: new Date().getTime()
        };
        localStorage.setItem('latin_tool_autosave', JSON.stringify(saveData));
        
        const status = document.getElementById('autosave-status');
        status.style.opacity = '1';
        setTimeout(() => { status.style.opacity = '0'; }, 2000);
    }
}

window.addEventListener('DOMContentLoaded', () => {
    setLanguage('en'); 

    const saved = localStorage.getItem('latin_tool_autosave');
    if(saved) {
        try {
            const data = JSON.parse(saved);
            if(new Date().getTime() - data.timestamp < 24 * 60 * 60 * 1000) {
                if(confirm("Found an unsaved project from " + new Date(data.timestamp).toLocaleTimeString() + ". Restore it?")) {
                    restoreAutoSave(data);
                }
            }
        } catch(e) { console.error("Autosave Error", e); }
    }
    setInterval(triggerAutoSave, 10000);
});

function restoreAutoSave(data) {
    if(data.lang) setLanguage(data.lang);
    if(data.title) document.getElementById('pagetitle').value = data.title;
    if(data.image) document.getElementById('pageimage').value = data.image;
    if(data.text) document.getElementById('entertext').value = data.text;
    if(data.notes) document.getElementById('teachernotes').value = data.notes;
    if(data.funcs) functions = data.funcs;
    if(data.cols) colors = data.cols;
    if(data.abbr) abbreviations = data.abbr;
    if(data.groups) currentGroups = data.groups;
    
    if(data.words && data.words.length > 0) {
        restoreEditorState(data.words);
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('editor-screen').style.display = 'block';
        renderPalette();
    }
}


// --- LOGIC ---
function addCustomLabel() {
    const input = document.getElementById('new-label-input');
    const name = input.value.trim();
    if(!name) return;
    if(functions.includes(name)) { alert("Label already exists!"); return; }
    functions.push(name);
    const randomColor = `hsl(${Math.floor(Math.random() * 360)}, 70%, 85%)`;
    colors[name] = randomColor;
    abbreviations[name] = name.substring(0,4) + '.';
    renderPalette();
    input.value = ''; 
}

function saveProject() {
    const domWords = Array.from(document.getElementById('tagging-area').childNodes).map((node) => {
        const isPunct = node.classList.contains('punct-span');
        return { 
            w: node.textContent, 
            f: isPunct ? 'Punct' : (node.dataset.func || 'Other'),
            isSplit: node.classList.contains('split-right')
        };
    });
    const projectData = { 
        lang: currentLang,
        title: document.getElementById('pagetitle').value, 
        image: document.getElementById('pageimage').value,
        notes: document.getElementById('teachernotes').value, 
        words: domWords, 
        groups: currentGroups, 
        customFunctions: functions, 
        customColors: colors, 
        customAbbr: abbreviations
    };
    const blob = new Blob([JSON.stringify(projectData, null, 2)], {type: "application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (projectData.title || "latin_project") + ".json"; a.click();
}

function loadProject(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(data.lang) setLanguage(data.lang);
            if(data.customFunctions) functions = data.customFunctions;
            if(data.customColors) colors = data.customColors;
            if(data.customAbbr) abbreviations = data.customAbbr;
            if(data.groups) currentGroups = data.groups;
            if(data.title) document.getElementById('pagetitle').value = data.title;
            if(data.image) document.getElementById('pageimage').value = data.image;
            if(data.notes) document.getElementById('teachernotes').value = data.notes; 
            if(data.words) {
                restoreEditorState(data.words);
                document.getElementById('setup-screen').style.display = 'none';
                document.getElementById('editor-screen').style.display = 'block';
                renderPalette();
            }
        } catch(err) { console.error(err); alert("Error loading file."); }
    };
    reader.readAsText(file);
    input.value = ''; 
}

function copyAIPrompt() {
    const txt = document.getElementById('entertext').value;
    const exObj = functions[1]; 
    
    const promptText = currentLang === 'de' 
    ? `Analysiere die lateinische Syntax von: "${txt}".
    1. STRIKTE REGEL: Behalte die EXAKTE Wortreihenfolge bei.
    2. PHRASEN: Benachbarte WÃ¶rter einer Phrase erhalten die gleiche Funktion.
    3. HYPERBATON: Getrennte Phrasen erhalten die gleiche Funktion, bleiben aber an ihrem Platz.
    4. INTERPUNKTION: Interpunktion als eigene Tokens "f": "Punct".
    5. Antworte mit JSON: { "words": [{"w": "Arma", "f": "${exObj}"}, ...], "groups": [{"label": "Relativsatz", "start": 0, "end": 4}] }
    Verwende diese Labels: ${functions.join(', ')}.`
    : `Analyze Latin syntax of: "${txt}". 
    1. STRICT RULE: Maintain the EXACT word order.
    2. PHRASES: Adjacent phrase words get same function. 
    3. HYPERBATON: Split phrases get same function but kept in place.
    4. PUNCTUATION: Include punctuation as separate tokens "f": "Punct".
    5. Return JSON: { "words": [{"w": "Arma", "f": "${exObj}"}, ...], "groups": [{"label": "Relative clause", "start": 0, "end": 4}] } 
    Labels: ${functions.join(', ')}.`;

    navigator.clipboard.writeText(promptText).then(() => alert(currentLang === 'de' ? "Prompt kopiert!" : "Prompt copied!"));
}

// Helper to merge prep+noun
function applyPrepositionMerging(tokens) {
    let welded = [];
    const prepLabel = currentLang === 'de' ? 'PrÃ¤positionalphrase' : 'Prepositional phrase';
    
    for(let i=0; i < tokens.length; i++) {
        let curr = tokens[i];
        let pureWord = curr.w.split(" ")[0].toLowerCase().replace(/[^a-z]/g, "");
        
        if(preps.includes(pureWord) && i+1 < tokens.length) {
            let nextW = tokens[i+1];
            if(nextW.f !== 'Punct') {
                welded.push({ 
                    w: curr.w + " " + nextW.w.replace(/^-/, ''), 
                    f: prepLabel
                });
                i++; 
            } else {
                welded.push(curr); 
            }
        } else {
            welded.push(curr);
        }
    }
    return welded;
}

function processTokens(rawTokens) {
    let temp = [];
    rawTokens.forEach(t => {
        const isEnclitic = /^-?(que|ne|ve)$/i.test(t);
        const hasLetters = /[a-zA-Z\u00C0-\u017F]/.test(t);
        if (!hasLetters) { temp.push({ w: t, f: 'Punct' }); }
        else if (isEnclitic && temp.length > 0 && /[a-zA-Z]/.test(temp[temp.length-1].w)) { temp[temp.length-1].w += t.replace(/^-/, ''); }
        else { temp.push({ w: t, f: 'Other' }); }
    });
    return applyPrepositionMerging(temp);
}

function importAI() {
    try {
        const raw = document.getElementById('ai-json').value;
        const cleanJson = raw.replace(/```json/g, '').replace(/```/g, '');
        const d = JSON.parse(cleanJson);
        currentGroups = (d.groups || []).filter(g => g.label && g.label.toLowerCase() !== "main clause" && g.start != null && g.end != null);
        d.words.forEach(w => {
            w.w = w.w.replace(/-/g, ' ');
            if (!/[a-zA-Z\u00C0-\u017F]/.test(w.w)) w.f = "Punct";
            else if (w.f === "Main clause") w.f = "Other";
        });
        
        const mergedWords = applyPrepositionMerging(d.words);
        initEditor(mergedWords);
    } catch(e) { console.error(e); alert("JSON error. Check console."); }
}

function startManual() {
    const rawInput = document.getElementById('entertext').value;
    const tokens = rawInput.match(/[a-zA-Z\u00C0-\u017F-]+|[^a-zA-Z\u00C0-\u017F\s]+/gi);
    if (!tokens) return;
    initEditor(processTokens(tokens));
}

// FORCE RESET function to allow clean slate
function initEditor(words) {
    // Reset to clean state for the current language
    functions = [...GRAMMAR[currentLang].funcs];
    abbreviations = {...GRAMMAR[currentLang].abbr};
    colors = mapColors(functions);
    historyStack = [];
    
    restoreEditorState(words);
    document.getElementById('setup-screen').style.display = 'none';
    document.getElementById('credits-screen').style.display = 'none';
    document.getElementById('editor-screen').style.display = 'block';
    renderPalette();
}

function renderPalette() {
    const p = document.getElementById('label-palette');
    p.innerHTML = '';
    functions.forEach(f => {
        const b = document.createElement('button');
        b.className = 'p-btn' + (f === activeFunc ? ' active' : '');
        b.style.backgroundColor = colors[f]; b.textContent = f;
        b.onclick = () => { activeFunc = f; groupMode = splitMode = false; updatePalette(); updateButtonStates(); };
        p.appendChild(b);
    });
    updateStatus();
}

function updatePalette() {
    document.querySelectorAll('.p-btn').forEach(b => b.classList.toggle('active', b.textContent === activeFunc));
    updateStatus();
}

function updateStatus() {
    let modeText = "";
    if (splitMode) modeText = LANG[currentLang].modeSplit;
    else if (groupMode) modeText = LANG[currentLang].modeBracket;
    else modeText = LANG[currentLang].modeTag + ` (${activeFunc})`;
    document.getElementById('mode-status').textContent = modeText;
}

function updateButtonStates() {
    document.getElementById('split-mode-btn').classList.toggle('active-mode', splitMode);
    document.getElementById('group-mode-btn').classList.toggle('active-mode', groupMode);
    if (splitMode || groupMode) {
        document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
    }
    updateStatus();
}

function handleWordClick(el) {
    const idx = parseInt(el.dataset.idx);
    if(splitMode) { 
        saveState(); 
        el.classList.toggle('split-right'); 
    } 
    else if(groupMode) {
        if(startIdx === null) { 
            startIdx = idx; el.style.outline = "3px solid #6f42c1"; 
        } 
        else {
            pendingGroupStart = Math.min(startIdx, idx);
            pendingGroupEnd = Math.max(startIdx, idx);
            openGroupModal();
            startIdx = null;
            document.querySelectorAll('.tag-word').forEach(s => s.style.outline = "none");
        }
    } else { 
        if (el.dataset.func !== activeFunc) {
            saveState(); 
            el.dataset.func = activeFunc; 
            const shortLabel = abbreviations[activeFunc] || (activeFunc.length > 6 ? activeFunc.substring(0,5)+"." : activeFunc);
            el.dataset.short = shortLabel;
            el.style.backgroundColor = colors[activeFunc]; 
        }
    }
}

function openGroupModal() {
    const modal = document.getElementById('group-modal');
    const datalist = document.getElementById('label-suggestions');
    const input = document.getElementById('group-name-input');
    datalist.innerHTML = '';
    functions.forEach(f => {
        const opt = document.createElement('option'); opt.value = f; datalist.appendChild(opt);
    });
    input.value = ''; modal.style.display = 'flex'; input.focus();
}

function closeGroupModal() { document.getElementById('group-modal').style.display = 'none'; }

function saveGroupFromModal() {
    const label = document.getElementById('group-name-input').value;
    if(label && pendingGroupStart !== null) {
        saveState(); 
        currentGroups.push({ start: pendingGroupStart, end: pendingGroupEnd, label: label });
        updateGroupUI();
    }
    closeGroupModal();
}
document.getElementById('group-name-input').addEventListener("keypress", function(event) { if (event.key === "Enter") saveGroupFromModal(); });
document.getElementById('group-name-input').addEventListener("keyup", function(event) { if (event.key === "Escape") closeGroupModal(); });

function updateGroupUI() {
    const list = document.getElementById('group-list');
    const wordSpans = Array.from(document.querySelectorAll('.tag-word, .punct-span'));
    wordSpans.forEach(s => { s.classList.remove('grouped-word', 'group-start', 'group-end'); s.title = ""; });
    currentGroups.forEach(g => {
        for(let i = g.start; i <= g.end; i++) {
            const el = document.getElementById(`word-${i}`);
            if(el && el.classList.contains('punct-span')) continue;
            if(el) {
                el.classList.add('grouped-word');
                if(i === g.start) el.classList.add('group-start');
                if(i === g.end) el.classList.add('group-end');
                el.title = g.label;
            }
        }
    });
    list.innerHTML = '';
    currentGroups.forEach((g, i) => {
        const slice = wordSpans.slice(g.start, g.end + 1);
        const phrase = slice.length > 0 ? slice.map(s => s.textContent).join(' ') : "Invalid Range";
        const d = document.createElement('div'); d.className = 'group-item';
        d.innerHTML = `<span><strong>${g.label}</strong>: "${phrase}"</span><span class="del-btn" onclick="removeGroup(${i})">âœ–</span>`;
        list.appendChild(d);
    });
}
function removeGroup(index) { 
    saveState(); 
    currentGroups.splice(index, 1); 
    updateGroupUI(); 
}
function toggleSplitMode() { splitMode = !splitMode; groupMode = false; activeFunc = "Other"; updatePalette(); updateButtonStates(); }
function toggleGroupMode() { groupMode = !groupMode; splitMode = false; activeFunc = "Other"; updatePalette(); updateButtonStates(); }

function exportToStudent() {
    const nodes = Array.from(document.getElementById('tagging-area').childNodes);
    let tempTokens = nodes.map(node => {
        const isPunct = node.classList.contains('punct-span');
        return { 
            w: node.textContent, 
            f: isPunct ? 'Punct' : node.dataset.func,
            isSplit: node.classList.contains('split-right'),
            idx: parseInt(node.dataset.idx)
        };
    });

    for(let i = 1; i < tempTokens.length - 1; i++) {
        let curr = tempTokens[i];
        if(curr.f === 'Punct') {
            let prev = tempTokens[i-1];
            let nextIdx = i + 1;
            while(nextIdx < tempTokens.length && tempTokens[nextIdx].f === 'Punct') {
                nextIdx++;
            }
            if(nextIdx < tempTokens.length) {
                let next = tempTokens[nextIdx];
                if(prev.f !== 'Punct' && prev.f !== 'Other' && prev.f === next.f && !prev.isSplit) {
                    curr.f = prev.f; 
                }
            }
        }
    }

    let merged = []; let current = null;
    tempTokens.forEach((token, i) => {
        const isMergeableType = !['Punct', 'Other'].includes(token.f);
        const prevToken = i > 0 ? tempTokens[i-1] : null;
        const splitExists = prevToken && prevToken.isSplit;
        const canMerge = current && current.f === token.f && isMergeableType && !splitExists;
        
        if (canMerge) {
            current.w += (['.', ',', ';', ':', '!', '?'].includes(token.w) ? '' : ' ') + token.w; 
            current.originalIndices.push(token.idx);
        } else {
            if (current) merged.push(current);
            current = { w: token.w, f: token.f, originalIndices: [token.idx] };
        }
    });
    if (current) merged.push(current);

    const updatedGroups = currentGroups.map(g => {
        const newStart = merged.findIndex(m => m.originalIndices.includes(g.start));
        let newEnd = merged.findIndex(m => m.originalIndices.includes(g.end));
        if(newEnd === -1) newEnd = newStart; 
        return { ...g, start: newStart, end: newEnd };
    });

    const titleInput = document.getElementById('pagetitle').value || "latin_exercise";
    const filename = titleInput.replace(/[^a-z0-9]/gi, '_').toLowerCase() + ".html";
    const imgUrl = document.getElementById('pageimage').value;
    const teacherNotes = document.getElementById('teachernotes').value;
    
    // Pass currentLang to the generator
    const blob = new Blob([generateStudentHTML(merged, updatedGroups, document.getElementById('pagetitle').value || "Exercise", functions, imgUrl, teacherNotes, currentLang)], {type: 'text/html'});
    const a = document.createElement('a'); 
    a.href = URL.createObjectURL(blob); 
    a.download = filename; 
    a.click();
}

// Student Page Generator now accepts lang
function generateStudentHTML(words, groups, title, allLabels, imgUrl, notes, lang) {
    const filteredLabels = allLabels.filter(l => l !== "Main clause" && l !== "Hauptsatz");
    
    const studentTexts = {
        en: {
            instr: "This page is designed to help you translate Latin sentences. One click on a word or group of words will open a button that will ask you to choose the syntactical function.<br>Once you have analysed each word in a sentence, a textbox will appear into which you can write your translation.",
            note: "Note:",
            togglePat: "Toggle Patterns",
            toggleCon: "High Contrast",
            print: "Print Analysis",
            download: "Download HTML",
            correct: "Correct!",
            incorrect: "Incorrect. The correct answer is: ",
            tryAgain: "Incorrect label, try again!",
            transPlaceholder: "Enter translation..."
        },
        de: {
            instr: "Diese Seite hilft dir beim Ãœbersetzen lateinischer SÃ¤tze. Klicke auf ein Wort oder eine Gruppe, um die syntaktische Funktion auszuwÃ¤hlen.<br>Sobald du jedes Wort in einem Satz analysiert hast, erscheint ein Textfeld fÃ¼r deine Ãœbersetzung.",
            note: "Hinweis:",
            togglePat: "Muster umschalten",
            toggleCon: "Hoher Kontrast",
            print: "Drucken",
            download: "HTML herunterladen",
            correct: "Richtig!",
            incorrect: "Falsch. Die richtige Antwort ist: ",
            tryAgain: "Falsches Label, versuch es nochmal!",
            transPlaceholder: "Ãœbersetzung eingeben..."
        }
    };

    const t = studentTexts[lang];

    const patternCSS = `
        body.pattern-mode .hover-word[data-done="true"] {
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.3) 5px, rgba(255,255,255,0.3) 10px);
            border: 2px solid #333 !important;
        }
        body.pattern-mode .hover-word[data-done="true"]:nth-child(even) {
             background-image: radial-gradient(rgba(255,255,255,0.4) 20%, transparent 20%), radial-gradient(rgba(255,255,255,0.4) 20%, transparent 20%);
             background-position: 0 0, 5px 5px;
             background-size: 10px 10px;
        }
        body.pattern-mode .s-group {
            border-style: dashed !important;
            border-width: 3px !important;
        }
    `;

    const contrastCSS = `
        body.high-contrast { background-color: #121212; color: #ffffff; }
        body.high-contrast .container, body.high-contrast .exercise-wrapper { background-color: #1e1e1e; color: #fff; border: 1px solid #444; }
        body.high-contrast .instruction-box { background-color: #332b00; border-color: #665500; color: #ffeb3b; }
        body.high-contrast .teacher-note { background: #1e1e1e !important; border: 1px solid #555 !important; color: #fff !important; }
        
        body.high-contrast .hover-word {
            background-color: #333;
            color: #fff;
            border-bottom: 3px solid #777;
        }
        body.high-contrast .hover-word[data-done="true"] {
            border: 2px solid #fff !important;
            color: #000; 
            font-weight: bold;
        }
        body.high-contrast .s-group { border-color: #fff !important; }
        body.high-contrast .g-label { background: #000; color: #fff; border-color: #fff; }
        body.high-contrast .punct { color: #fff; }
        body.high-contrast textarea { background: #2d2d2d; color: #fff; border: 1px solid #555; }
    `;

    return `<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>
        :root { --main-font: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; }
        body, button, input, textarea, select { font-family: var(--main-font); }
        body { margin: 2% auto; max-width: 1200px; padding: 0 20px; background-color: #f4f4f9; color: #333; }
        h1 { text-align: center; color: #444; margin-bottom: 30px; font-weight: normal; letter-spacing: 1px; }
        .instruction-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 25px; font-size: 0.95rem; line-height: 1.6; color: #856404; }
        .teacher-note { background: #f9f9f9; border: 1px solid #eee; padding: 15px; border-radius: 4px; margin-bottom: 25px; font-size: 1rem; color: #333; }
        .exercise-wrapper { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); line-height: 3.8; }
        .hover-word { cursor: pointer; background: #e4e5ed; padding: 2px 8px; border-radius: 4px; border-bottom: 3px solid #ccc; font-size: 1.15rem; position: relative; display: inline-block; line-height: 1.2; transition: all 0.2s; }
        .s-group { display: inline-block; position: relative; border: 2px solid #555; border-bottom:none; border-radius: 8px 8px 0 0; padding: 15px 5px 5px 5px; margin: 0 2px; vertical-align: bottom; }
        .g-label { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: bold; background: white; border: 1px solid #555; border-radius: 4px; padding: 2px 8px; white-space: nowrap; color: #555; text-transform: uppercase; cursor: pointer; }
        .punct { font-size: 1.15rem; margin: 0 1px; vertical-align: baseline; display:inline-block; }
        .trans-box { margin: 20px 0 50px; line-height: 1.5; }
        textarea { width: 100%; height: 80px; font-size: 1.2rem; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .ans-label { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: bold; margin-top: 8px; width: 150px; text-align: center; color: green; pointer-events: none; }
        .radio-menu { display: none; position: absolute; background-color: white; border: 1px solid #bbb; padding: 0; z-index: 1000; border-radius: 4px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); max-height: 400px; overflow-y: auto; min-width: 160px; line-height: 1.2; }
        .radio-menu input[type="radio"] { display: none; }
        .radio-menu label { display: block; padding: 1px 8px; cursor: pointer; border-bottom: none; font-size: 0.85rem; font-weight: bold; color: #333; }
        .radio-menu label:hover { background-color: #007bff; color: white; }
        .footer-toolbar { margin-top: 60px; padding: 30px; border-top: 1px solid #ddd; display: flex; justify-content: center; gap: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; background: #333; }
        .ex-img { max-width: 100%; height: auto; display: block; margin: 30px auto 10px auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-height: 300px; object-fit: contain; }
        #toast-container { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 1001; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast-container.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast-container.error { background-color: #333; border-bottom: 4px solid #d32f2f; }
        #toast-container.success { background-color: #333; border-bottom: 4px solid #28a745; }
        ${patternCSS}
        ${contrastCSS}
        @media (max-width: 768px) {
            body { margin: 15px; line-height: 4.0; }
            .exercise-wrapper { padding: 15px; }
            .hover-word { font-size: 1.15rem; padding: 6px 10px; }
            .g-label { top: -20px; font-size: 10px; padding: 2px 4px; }
            .s-group { padding-top: 20px; margin: 0 2px; }
            .radio-menu { position: fixed; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%); width: 80%; max-height: 60%; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 8px; }
            .radio-menu label { padding: 12px 15px; font-size: 1rem; border-bottom: 1px solid #eee; }
        }
        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } .footer-toolbar, .radio-menu, .instruction-box { display: none !important; } .ex-img { display: none !important; } }
    </style></head><body>
    <h1>${title}</h1>
    <div class="instruction-box">${t.instr}</div>
    ${notes ? `<div class="teacher-note"><strong>${t.note}</strong> ${notes.replace(/\n/g, '<br>')}</div>` : ''}
    <div class="exercise-wrapper"><div id="exercise">${generateExerciseHTML(words, groups, t.transPlaceholder)}</div></div>
    ${imgUrl ? `<img src="${imgUrl}" class="ex-img" alt="Exercise Image">` : ''}
    <div class="footer-toolbar">
        <button class="btn" onclick="togglePatterns()">${t.togglePat}</button>
        <button class="btn" onclick="toggleContrast()">${t.toggleCon}</button>
        <button class="btn" onclick="window.print()">${t.print}</button> 
        <button class="btn" onclick="downloadPage()">${t.download}</button>
    </div>
    <div id="menu-common" class="radio-menu"><form id="f-common">${filteredLabels.map(l => `<label><input type="radio" name="opt" value="${l}"> ${l}</label>`).join('')}</form></div>
    <div id="toast-container"></div>
    <script>
        const colors = ${JSON.stringify(colors)}; let activeEl = null; let mode = "";
        const menu = document.getElementById('menu-common');
        document.querySelectorAll('.hover-word, .g-label').forEach(el => {
            el.onclick = (e) => {
                e.stopPropagation();
                if(el.dataset.done) return;
                activeEl = el; mode = el.classList.contains('hover-word') ? "word" : "group";
                if(window.innerWidth > 768) { menu.style.top=e.pageY+"px"; menu.style.left=e.pageX+"px"; }
                menu.style.display="block"; 
            };
        });
        document.getElementById('f-common').onchange = (e) => {
            const sel = e.target.value; 
            const correct = mode === "word" ? activeEl.dataset.ans : activeEl.parentElement.dataset.ans;
            if(sel === correct) {
                solve(activeEl, correct, mode);
                showToast("${t.correct}", false);
            } else { 
                let mistakes = parseInt(activeEl.dataset.mistakes || 0) + 1;
                activeEl.dataset.mistakes = mistakes;
                if(mistakes >= 2) {
                       showToast("${t.incorrect}" + correct, true);
                       solve(activeEl, correct, mode);
                } else {
                       showToast("${t.tryAgain}", true);
                }
            }
            menu.style.display = "none"; e.target.checked = false; check();
        };
        function showToast(msg, isError) {
            const x = document.getElementById("toast-container");
            x.textContent = msg;
            x.className = isError ? "show error" : "show success";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }
        function togglePatterns() { document.body.classList.toggle('pattern-mode'); }
        function toggleContrast() { document.body.classList.toggle('high-contrast'); }
        function solve(el, ans, m) {
            if(m === "word") {
                const s = document.createElement('span'); s.className = 'ans-label'; s.textContent = ans; el.appendChild(s);
                el.style.backgroundColor = colors[ans]; el.dataset.done = "true";
            } else { 
                el.textContent = ans; el.dataset.done = "true"; el.style.background = "#e8f5e9"; 
            }
        }
        function check() { 
            document.querySelectorAll('.sentence-container').forEach((s, i) => { 
                const items = [...s.querySelectorAll('.hover-word'), ...s.querySelectorAll('.g-label')];
                if(items.length > 0 && items.every(item => item.dataset.done === "true")) {
                    const b = document.getElementById('t-container-' + i); if(b) b.style.display = 'block';
                }
            }); 
        }
        function downloadPage() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([document.documentElement.outerHTML], {type: 'text/html'})); a.download = 'latin_exercise.html'; a.click(); }
        document.addEventListener('mousedown', (e) => { if(!e.target.closest('.radio-menu')) menu.style.display = 'none'; });
    <\/script></body></html>`;
}

function generateExerciseHTML(words, groups, placeholder) {
    let sIdx = 0, html = '<div class="sentence-container">';
    const sentenceEnders = ['.', '!', '?', 'Â·'];
    let pendingClosers = ""; 

    words.forEach((word, idx) => {
        const hasLetters = /[a-zA-Z\u00C0-\u017F]/.test(word.w);
        let isFakeWord = !hasLetters; 
        let isPunct = word.f === 'Punct' || isFakeWord;
        let nextWord = words[idx + 1];
        let nextIsPunct = nextWord && (!/[a-zA-Z\u00C0-\u017F]/.test(nextWord.w) || nextWord.f === 'Punct');
        let content = isPunct ? `<span class="punct">${word.w}</span>` : `<span class="hover-word" data-ans="${word.f}">${word.w}</span>`;
        let openDivs = "", closeDivs = "";

        groups.forEach(g => {
            if(idx === g.start) openDivs += `<div class="s-group" data-ans="${g.label}"><span class="g-label">?</span>`;
            if(idx === g.end) closeDivs += `</div>`;
        });
        let spacing = nextIsPunct ? "" : " ";

        if (isPunct) {
            html += openDivs + content + pendingClosers + closeDivs + spacing;
            pendingClosers = ""; 
        } else {
            html += openDivs + content;
            if (closeDivs && nextIsPunct) {
                pendingClosers = closeDivs;
            } else {
                html += closeDivs;
            }
            html += spacing;
        }

        if (isPunct && sentenceEnders.some(end => word.w.includes(end))) {
            html += `</div><div id="t-container-${sIdx}" class="trans-box" style="display:none;"><textarea placeholder="${placeholder}"></textarea></div><div class="sentence-container">`;
            sIdx++;
        }
    });
    return html + "</div>";
}
</script>
</body>
</html>
